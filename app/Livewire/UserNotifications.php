<?php

namespace App\Livewire;

use Illuminate\Support\Facades\Auth;
use Livewire\Component;

class UserNotifications extends Component
{
    // ๐ก ุฎุงุตูุฉ ูุชุฎุฒูู ุนุฏุฏ ุงูุฅุดุนุงุฑุงุช ุบูุฑ ุงูููุฑูุกุฉ
    public $unreadNotificationsCount;

    // ๐ก ุฎุงุตูุฉ ูุชุฎุฒูู ุงูุฅุดุนุงุฑุงุช ุงูุชู ุณูุชู ุนุฑุถูุง ูู ุงููุงุฆูุฉ
    public $notifications;

    /**
     * ุฏุงูุฉ mount ุชูููุฐ ูุฑุฉ ูุงุญุฏุฉ ุนูุฏ ุชุญููู ุงููููู ูุฃูู ูุฑุฉ.
     * ูุณุชุฎุฏููุง ูุฌูุจ ุงูุจูุงูุงุช ุงูุฃูููุฉ.
     */
    public function mount()
    {
        $this->loadNotifications();
    }

    /**
     * ุฏุงูุฉ ูุฎุตุตุฉ ูุฌูุจ ุงูุฅุดุนุงุฑุงุช ูุชุญุฏูุซ ุงูุนุฏุฏ.
     * ูููููุง ุงุณุชุฏุนุงุคูุง ูู ุฃู ููุช ูุชุญุฏูุซ ุงูุจูุงูุงุช.
     */
    public function loadNotifications()
    {
        // ูุชุฃูุฏ ูู ูุฌูุฏ ูุณุชุฎุฏู ูุณุฌู ุฏุฎููู
        if (Auth::check()) {
            $user = Auth::user();
            // ุฌูุจ ุขุฎุฑ 10 ุฅุดุนุงุฑุงุช (ููููู ุชุบููุฑ ุงูุนุฏุฏ)
            $this->notifications = $user->notifications()->take(10)->get();
            // ุฌูุจ ุนุฏุฏ ุงูุฅุดุนุงุฑุงุช ุบูุฑ ุงูููุฑูุกุฉ ููุท
            $this->unreadNotificationsCount = $user->unreadNotifications->count();
        } else {
            // ุฅุฐุง ูู ููู ููุงู ูุณุชุฎุฏูุ ูุฌุนู ูู ุดูุก ูุงุฑุบูุง
            $this->notifications = collect();
            $this->unreadNotificationsCount = 0;
        }
    }
 /**
     * ุฏุงูุฉ ูุชูููุฒ ุฅุดุนุงุฑ ูุนูู ูููุฑูุก ูุชูุฌูู ุงููุณุชุฎุฏู.
     * ุณูุชู ุงุณุชุฏุนุงุคูุง ุนูุฏ ุงูุถุบุท ุนูู ุฅุดุนุงุฑ ูู ุงููุงุฆูุฉ.
     * @param string $notificationId
     */
    public function markAsRead(string $notificationId)
    {
        if (Auth::check()) {
            $notification = Auth::user()->notifications()->find($notificationId);

            if ($notification) {
                // ุงูุฎุทูุฉ 1: ุชูููุฒ ุงูุฅุดุนุงุฑ ูููุฑูุก
                $notification->markAsRead();

                // ๐ก ุงูุฎุทูุฉ 2 (ุงูุฌุฏูุฏุฉ ูุงููููุฉ): ุงูุชุญูู ูู ูุฌูุฏ ุฑุงุจุท ูุชูุฌูู ุงููุณุชุฎุฏู
                if (isset($notification->data['url'])) {
                    // ุงุณุชุฎุฏุงู redirect() ูุชูุฌูู ุงููุณุชุฎุฏู ุฅูู ุงูุฑุงุจุท ุงููุญุฏุฏ
                    return $this->redirect($notification->data['url'], navigate: true);
                }
            }
            // ูู ุญุงู ุนุฏู ูุฌูุฏ ุฑุงุจุทุ ููุท ูู ุจุชุญุฏูุซ ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช
            $this->loadNotifications();
        }
    }

    /**
     * ุฏุงูุฉ ูุชูููุฒ ุฌููุน ุงูุฅุดุนุงุฑุงุช ูููุฑูุกุฉ.
     * ุณูุชู ุงุณุชุฏุนุงุคูุง ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ "ุชูููุฒ ุงููู ูููุฑูุก".
     */
    public function markAllAsRead()
    {
        if (Auth::check()) {
            Auth::user()->unreadNotifications->markAsRead();
            // ุฅุนุงุฏุฉ ุชุญููู ุงูุฅุดุนุงุฑุงุช ุจุนุฏ ุงูุชุบููุฑ ูุชุญุฏูุซ ุงููุงุฌูุฉ
            $this->loadNotifications();
        }
    }

    /**
     * ุฏุงูุฉ render ูู ุงููุณุคููุฉ ุนู ุนุฑุถ ุงููุงุฌูุฉ.
     * ๐ก ุณูุถูู wire:poll ููุง ูุฌุนู ุงููููู ูููู ุจุชุญุฏูุซ ููุณู ุชููุงุฆููุง.
     * ุณูููู ุจุงุณุชุฏุนุงุก ุฏุงูุฉ loadNotifications() ูู 15 ุซุงููุฉ.
     */
    public function render()
    {
        // ุงุณุชุฏุนุงุก ุฏุงูุฉ loadNotifications ูุจู ุนุฑุถ ุงููุงุฌูุฉ ูุถูุงู ุฃู ุงูุจูุงูุงุช ูุญุฏุซุฉ
        // ูุฐุง ูููุฏ ุจุดูู ุฎุงุต ูุน wire:poll
        $this->loadNotifications();

        return view('livewire.user-notifications');
    }
}

// **ุดุฑุญ ุจุณูุท ููููุฏ:**
// *   `mount()`: ุชุฌูุฒ ุงูุจูุงูุงุช ุนูุฏ ุฃูู ุชุญููู.
// *   `loadNotifications()`: ูู ุฏุงูุชูุง ุงูุฑุฆูุณูุฉ ูุฌูุจ ุงูุจูุงูุงุช.
// *   `markAsRead()` ู `markAllAsRead()`: ููุง ุงูุฏุงูุชุงู ุงููุชุงู ุณุชุชูุงุนูุงู ูุน ุงููุณุชุฎุฏู.
// *   `render()`: ุชุนุฑุถ ุงููุงุฌูุฉ ูุชุณุชุฎุฏู `wire:poll` (ุณูุถูููุง ูู ููู ุงูู view) ูุชุธู ุญูุฉ ููุญุฏุซุฉ.

// ุจุนุฏ ุงุณุชุจุฏุงู ุงูููุฏุ ุชููู ูุฏ ุฃูุฌุฒุช ุงูุฎุทูุฉ ุงูุณุงุฏุณุฉ. ุฃุตุจุญ ูุฏููุง ุงูุขู "ุนูู" ุงููููู ุฌุงูุฒุงู.

// **ุงูุฎุทูุฉ ุงูุชุงููุฉ ูู ุชุตููู "ุฌุณู" ุงูููููุ ุฃู ุงููุงุฌูุฉ ุงูุชู ุณูุฑุงูุง ุงููุณุชุฎุฏู. ูู ุฃูุช ูุณุชุนุฏ ููุฎุทูุฉ 7ุ**
